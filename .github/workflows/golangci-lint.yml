name: Run golangci-lint and tests

on:
  push:
    branches: [ "main", "master", "microservices" ]
  pull_request:
    branches: [ "main", "master", "microservices" ]

jobs:
  lint-all:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [
          "SkillForceBillingService",
          "SkillForceCourseService",
          "SkillForceMailService",
          "SkillForceMainService",
          "SkillForceUserService"
        ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build golangci-lint docker image for ${{ matrix.service }}
        run: |
          cd ${{ matrix.service }}
          docker build -f ../Dockerfile.golangci-lint -t golangci-lint:1.23 .
      
      - name: Run golangci-lint on ${{ matrix.service }}
        run: |
          docker run --rm golangci-lint:1.23
      
      - name: Run tests for ${{ matrix.service }}
        run: |
          go test -coverpkg=./... -coverprofile=cover.out.tmp ./...
          grep -v "mock" cover.out.tmp > cover.out
          go tool cover -func=cover.out
